{% extends 'base.html' %}
{% load i18n %}

{% block title %}
    {% if object %}{% trans "Edit Budget" %}{% else %}{% trans "Create Budget" %}{% endif %}
{% endblock %}

{% block body %}
    <div class="budget-form form-container">
        <h2>{% if object %}{% trans "Edit Budget" %}{% else %}{% trans "Create New Budget" %}{% endif %}</h2>

        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label for="id_name">{% trans "Budget Name" %}:</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="error">{{ form.name.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="period_type">{% trans "Period Type" %}:</label>
                <select name="period_type" id="period_type" required class="form-control">
                    <option value="MONTHLY" {% if form.period_type.value == 'MONTHLY' or form.instance.period_type == 'MONTHLY' %}selected{% endif %}>{% trans "Monthly" %}</option>
                    <option value="QUARTERLY" {% if form.period_type.value == 'QUARTERLY' or form.instance.period_type == 'QUARTERLY' %}selected{% endif %}>{% trans "Quarterly" %}</option>
                    <option value="YEARLY" {% if form.period_type.value == 'YEARLY' or form.instance.period_type == 'YEARLY' %}selected{% endif %}>{% trans "Yearly" %}</option>
                    <option value="CUSTOM" {% if form.period_type.value == 'CUSTOM' or form.instance.period_type == 'CUSTOM' %}selected{% endif %}>{% trans "Custom Period" %}</option>
                </select>
            </div>
            <div class="form-group">
                <label for="start_date">{% trans "Start Date" %}:</label>
                <input type="date" name="start_date" id="start_date" value="{% if form.start_date.value %}{{ form.start_date.value|date:'Y-m-d' }}{% elif form.instance.start_date %}{{ form.instance.start_date|date:'Y-m-d' }}{% endif %}" required class="form-control">
            </div>
            <div class="form-group">
                <label for="end_date">{% trans "End Date" %}:</label>
                <input type="date" name="end_date" id="end_date" value="{% if form.end_date.value %}{{ form.end_date.value|date:'Y-m-d' }}{% elif form.instance.end_date %}{{ form.instance.end_date|date:'Y-m-d' }}{% endif %}" required class="form-control">
            </div>

            <div class="form-group">
                <label for="id_total_expense_limit">{% trans "Total Expense Limit" %}:</label>
                {{ form.total_expense_limit }}
                {% if form.total_expense_limit.errors %}
                    <div class="error">{{ form.total_expense_limit.errors }}</div>
                {% endif %}
            </div>

            <!--<h3>Category Limits</h3>
            {{ category_limits.management_form }}
            {% for formset in category_limits %}
                <div class="form-group">
                    <label>Category:</label>
                    {{ formset.category }}
                    <label>Limit Amount:</label>
                    {{ formset.limit_amount }}
                    {% if formset.DELETE %}
                        <label>Delete:</label> {{ formset.DELETE }}
                    {% endif %}
                </div>
            {% endfor %}-->

            {% if not object %}

            <h3>{% trans "Category Limits" %}</h3>
            {{ category_limits.management_form }}

            {% if category_limits.non_form_errors %}
                <div class="error non-field-errors">
                    {% for error in category_limits.non_form_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
                
            <div id="category-limits-forms">
                {% for formset in category_limits %}
                    <div class="category-limit-form">
                        {{ formset.category }}
                        {{ formset.limit_amount }}
            
                        <label class="delete-label" style="margin-left: 1rem; cursor: pointer;">
                            {{ formset.DELETE }} {% trans "Delete" %}
                        </label>
            
                        {% if formset.errors %}
                            <div class="error">{{ formset.errors }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            
            <!-- Шаблон пустой формы formset'а (используем __prefix__) -->
            <div id="empty-category-limit-form" style="display: none;">
                <div class="category-limit-form">
                    {{ category_limits.empty_form.category }}
                    {{ category_limits.empty_form.limit_amount }}
                    <label class="delete-label" style="margin-left: 1rem; cursor: pointer;">
                        {{ category_limits.empty_form.DELETE }} {% trans "Delete" %}
                    </label>
                </div>
            </div>

            <button type="button" id="add-category-limit-btn" class="btn btn-secondary">{% trans "Add Category Limit" %}</button>
            
            {% endif %}
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    {% if object %}{% trans "Update Budget" %}{% else %}{% trans "Create Budget" %}{% endif %}
                </button>
                <a href="{% url 'transaction:budget-list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const formsContainer = document.getElementById('category-limits-forms');
            const totalFormsInput = document.getElementById('id_category_limits-TOTAL_FORMS');
            const emptyFormTemplate = document.getElementById('empty-category-limit-form').innerHTML;
            const addBtn = document.getElementById('add-category-limit-btn');

            // Скрыть формы, которые уже помечены на удаление при загрузке страницы
            const existingForms = formsContainer.querySelectorAll('.category-limit-form');
            existingForms.forEach(function(row) {
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteCheckbox && deleteCheckbox.checked) {
                    row.style.display = 'none';
                }
            });

            // Добавление новой формы по кнопке
            addBtn.addEventListener('click', function () {
                const index = parseInt(totalFormsInput.value);
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, index);
                formsContainer.insertAdjacentHTML('beforeend', newFormHtml);
                totalFormsInput.value = index + 1;
            });

            // Делегирование кликов по "Delete"
            formsContainer.addEventListener('click', function (e) {
                const deleteLabel = e.target.closest('.delete-label');
                if (!deleteLabel) return;

                const row = deleteLabel.closest('.category-limit-form');
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                const idField = row.querySelector('input[name$="-id"]');

                if (idField && idField.value) {
                    // Существующая запись: помечаем на удаление и скрываем строку
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                    }
                    row.style.display = 'none';
                } else {
                    // Новая несохранённая форма: просто удаляем из DOM и пересчитываем количество форм
                    row.remove();
                    const forms = formsContainer.querySelectorAll('.category-limit-form:not([style*="display: none"])');
                    totalFormsInput.value = forms.length;
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const periodSelect = document.getElementById('period_type');
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
          
            // Проверяем, редактируем ли мы существующий бюджет
            const isEditing = {% if object %}true{% else %}false{% endif %};
          
            function setDates() {
              // При редактировании не перезаписываем существующие даты
              if (isEditing && startDateInput.value && endDateInput.value) {
                return;
              }
              
              const today = new Date();
              let startDate, endDate;
          
              switch (periodSelect.value) {
                case 'MONTHLY':
                  startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                  endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                  break;
                case 'QUARTERLY':
                  const quarter = Math.floor(today.getMonth() / 3);
                  startDate = new Date(today.getFullYear(), quarter * 3, 1);
                  endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                  break;
                case 'YEARLY':
                  startDate = new Date(today.getFullYear(), 0, 1);
                  endDate = new Date(today.getFullYear(), 11, 31);
                  break;
                case 'CUSTOM':
                  // Для кастомного периода — оставим поля пустыми
                  return;
              }
          
              // Устанавливаем даты только если они пустые
              if (!startDateInput.value) {
                startDateInput.value = startDate.toISOString().split('T')[0];
              }
              if (!endDateInput.value) {
                endDateInput.value = endDate.toISOString().split('T')[0];
              }
            }
          
            // Вызвать при загрузке для установки дат по умолчанию (только для новых бюджетов)
            if (!isEditing) {
              setDates();
            }
          
            // Обработчик на изменение периода (работает всегда, но при редактировании пользователь может изменить)
            periodSelect.addEventListener('change', function() {
              // При редактировании позволяем пользователю изменить даты вручную
              if (!isEditing || (!startDateInput.value || !endDateInput.value)) {
                setDates();
              }
            });
          });
    </script>
    <style>
        .budget-form {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
        }
    </style>
{% endblock %}
