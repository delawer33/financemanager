{% extends 'base.html' %}
{% load i18n %}

{% block title %}
    {% trans "Dashboard" %}
{% endblock %}

{% block body %}

{% load i18n %}
    <div class="metrics">
        <div class="card">
            <h3>{% trans "Income (30 days)" %}</h3>
            <p>{{ total_income }} {{ user.currency.symbol }}</p>
        </div>
        <div class="card">
            <h3>{% trans "Expense (30 days)" %}</h3>
            <p>{{ total_expense }} {{ user.currency.symbol }}</p>
        </div>
        <div class="card">
            <h3>{% trans "Total Balance" %}</h3>
            <p>{{ balance }} {{ user.currency.symbol }}</p>
        </div>
    </div>

    <h2>{% trans "Your Accounts" %}</h2>
    <div class="accounts-grid">
        {% for account in accounts %}
            <div class="card account-card">
                <div class="account-header">
                    <strong>{{ account.name }}</strong>
                    <span class="account-type">{{ account.get_account_type_display }}</span>
                </div>
                <div class="account-balance">{{ account.balance }} {{ account.currency }}</div>
            </div>
        {% empty %}
            <p>{% trans "No accounts found." %}</p>
        {% endfor %}
    </div>

    {% if budget %}
        <h2>{% trans "Current Budget" %}</h2>
        <div class="budget-card">
            <div class="budget-header">
                <h3 class="budget-title">{{ budget.name }}</h3>
                <span>{{ budget.start_date }} — {{ budget.end_date }}</span>
            </div>
            <div class="budget-details">
                <p>{% trans "Limit" %}: {{ budget.total_expense_limit }} {{ user.currency.symbol }}</p>
                <p>{% trans "Spent" %}: {{ budget_spent }} {{ user.currency.symbol }}</p>
                <p>{% trans "Remaining" %}: {{ budget_remaining }} {{ user.currency.symbol }}</p>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: {{ budget_percentage|stringformat:".2f" }}%;"></div>
                </div>
                <p class="progress-text">{{ budget_percentage|floatformat:1 }}%</p>
            </div>

            <h3>{% trans "Expenses by Category" %}</h3>
            {% if budget_expense_by_category %}
            {% for item in budget_expense_by_category %}
                <div class="category-progress">
                <strong>{{ item.category__name|default:_('Other') }}</strong>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: {{ item.usage_percent|stringformat:".2f" }}%;"></div>
                </div>
                <small>{% blocktrans with total=item.total limit=item.limit symbol=user.currency.symbol %}{{ total }} {{ symbol }} used of {{ limit }} {{ symbol }}{% endblocktrans %}</small>
                </div>
            {% endfor %}
            {% else %}
            <p>{% trans "No expense data by category." %}</p>
            {% endif %}

        </div>
    {% endif %}



    <div class="charts">
        <div class="chart-container">
            <canvas id="incomeExpenseChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="expenseDistributionChart"></canvas>
        </div>
    </div>

    <!-- Формы для создания аккаунта и бюджета -->
    <div class="forms-section">
        <div class="form-container">
            <h3>{% trans "Create New Account" %}</h3>
            <form method="post" action="{% url 'transaction:account-create' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="account_name">{% trans "Account Name" %}:</label>
                    <input type="text" name="name" id="account_name" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="account_type">{% trans "Account Type" %}:</label>
                    <select name="account_type" id="account_type" required class="form-control">
                        <option value="BANK">{% trans "Bank Account" %}</option>
                        <option value="CASH">{% trans "Cash" %}</option>
                        <option value="CREDIT_CARD">{% trans "Credit Card" %}</option>
                        <option value="INVESTMENT">{% trans "Investment Account" %}</option>
                        <option value="SAVINGS">{% trans "Savings Account" %}</option>
                        <option value="WALLET">{% trans "Digital Wallet" %}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="initial_balance">{% trans "Initial Balance" %}:</label>
                    <input type="number" name="initial_balance" id="initial_balance" step="0.01" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="currency">{% trans "Currency" %}:</label>
                    <input type="text" name="currency" id="currency" maxlength="3" value="USD" required class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">{% trans "Create Account" %}</button>
            </form>
        </div>

        <div class="form-container">
            <h3>{% trans "Create New Budget" %}</h3>
            <form method="get" action="{% url 'transaction:budget-create' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="budget_name">{% trans "Budget Name" %}:</label>
                    <input type="text" name="name" id="budget_name" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="period_type">{% trans "Period Type" %}:</label>
                    <select name="period_type" id="period_type" required class="form-control">
                        <option value="MONTHLY">{% trans "Monthly" %}</option>
                        <option value="QUARTERLY">{% trans "Quarterly" %}</option>
                        <option value="YEARLY">{% trans "Yearly" %}</option>
                        <option value="CUSTOM">{% trans "Custom Period" %}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_date">{% trans "Start Date" %}:</label>
                    <input type="date" name="start_date" id="start_date" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="end_date">{% trans "End Date" %}:</label>
                    <input type="date" name="end_date" id="end_date" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="total_expense_limit">{% trans "Total Expense Limit" %}:</label>
                    <input type="number" name="total_expense_limit" id="total_expense_limit" step="0.01" required class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">{% trans "Create Budget" %}</button>
            </form>
        </div>
    </div>

    <script>
        const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
        new Chart(incomeExpenseCtx, {
            type: 'line',
            data: {
                labels: {{ labels|safe }},
                datasets: [
                    {
                        label: '{% trans "Income" %}',
                        data: {{ income_data|safe }},
                        borderColor: '#4CAF50',
                        fill: false
                    },
                    {
                        label: '{% trans "Expense" %}',
                        data: {{ expense_data|safe }},
                        borderColor: '#F44336',
                        fill: false
                    }
                ]
            },
            options: {
                devicePixelRatio: 2,
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    x: { title: { display: true, text: '{% trans "Date" %}' } },
                    y: { type: 'logarithmic', title: { display: true, text: '{% trans "Sum" %}' } }
                }
            }
        });

        const expenseDistributionCtx = document.getElementById('expenseDistributionChart').getContext('2d');
        new Chart(expenseDistributionCtx, {
            type: 'polarArea',
            data: {
                labels: [{% for c in expense_categories %}{% if c.category__name %}"{{ c.category__name }}"{% else %}"Other"{% endif %}, {% endfor %}],
                datasets: [{
                    data: [{% for c in expense_categories %}{{ c.total }},{% endfor %}],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FFCD56', '#C9CBCF', '#4D5360', '#F7464A'
                    ]
                }]
            },
            options: {
                devicePixelRatio: 2,
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // JavaScript для автоматического заполнения дат в форме бюджета
        document.addEventListener('DOMContentLoaded', () => {
            const periodSelect = document.getElementById('period_type');
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
          
            function setDates() {
              const today = new Date();
              let startDate, endDate;
          
              switch (periodSelect.value) {
                case 'MONTHLY':
                  startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                  endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                  break;
                case 'QUARTERLY':
                  const quarter = Math.floor(today.getMonth() / 3);
                  startDate = new Date(today.getFullYear(), quarter * 3, 1);
                  endDate = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
                  break;
                case 'YEARLY':
                  startDate = new Date(today.getFullYear(), 0, 1);
                  endDate = new Date(today.getFullYear(), 11, 31);
                  break;
                case 'CUSTOM':
                  // Для кастомного периода — оставим поля пустыми
                  return;
              }
          
              startDateInput.value = startDate.toISOString().split('T')[0];
              endDateInput.value = endDate.toISOString().split('T')[0];
            }
          
            // Вызвать при загрузке для установки дат по умолчанию
            setDates();
          
            // Также оставить обработчик на изменение периода, чтобы менять при необходимости
            periodSelect.addEventListener('change', setDates);
          });
    </script>

    <style>
        .budget-card {
            max-width: 800px;
            width: 90%;
            margin: 2rem auto 3rem auto;
            background-color: white; /* яркий желтый фон из вашей темы */
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            box-shadow: var(--shadow-lg);
            color: var(--gray-900);
            font-family: 'Inter', sans-serif;
            transition: box-shadow 0.3s ease;
            border: 1.5px solid var(--primary);
        }
        
        .budget-card:hover {
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.5);
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            margin-bottom: 1.25rem;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 0.4rem;
            color: var(--gray-900);
        }
        
        .budget-details {
            font-size: 1.15rem;
            line-height: 1.6;
        }
        
        .budget-details p {
            margin: 0.5rem 0;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .progress-bar-bg {
            background-color: var(--gray-200);
            border-radius: var(--border-radius);
            height: 24px;
            width: 100%;
            overflow: hidden;
            margin: 0.75rem 0 0.3rem;
            border: 1px solid var(--primary);
        }
        
        .progress-bar-fill {
            background-color: var(--primary);
            height: 100%;
            width: 0%;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            transition: width 0.5s ease-in-out;
        }
        
        .progress-text {
            font-weight: 700;
            font-size: 1rem;
            text-align: right;
            color: var(--gray-800);
            user-select: none;
        }
        
        .category-progress {
        }
        
        .category-progress strong {
            display: block;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
            color: var(--primary-dark);
        }
        
        .category-progress .progress-bar-bg {
            height: 18px;
            border-radius: 10px;
            margin-bottom: 0.25rem;
            background-color: var(--gray-300);
            border: none;
        }

        .budget-title {
            font-weight: 700 !important;
            font-size: 2rem !important;
            color: black !important;
            margin: 0 !important;
            user-select: none;
        }        
        
        .category-progress .progress-bar-fill {
            background-color: var(--secondary);
            border-radius: 10px 0 0 10px;
        }
        
        .category-progress small {
            font-size: 0.85rem;
            color: var(--gray-600);
            display: block;
            text-align: right;
            font-weight: 500;
            user-select: text;
        }
        
        
        .category-expenses {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .category-expenses li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #ddd;
            font-size: 1rem;
        }
        .category-expenses li strong {
            color: #343a40;
        }
        
        .forms-section {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .form-container {
            flex: 1;
            min-width: 300px;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .form-container h3 {
            margin-bottom: 1rem;
            color: #333;
        }
    </style>
    <style>

        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 1rem;
            margin-bottom: 3rem;
        }
        .account-card {
            background:rgb(255, 255, 255);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .account-header {
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            color: #343a40;
        }
        .account-type {
            color: var(--primary);
            text-transform: uppercase;
            margin-left: 15px;
        }
        .account-balance {
            font-size: 1.3rem;
            font-weight: 600;
            text-align: right;
            
        }

        .progress-bar-bg {
            background: #ffe8a1;
            border-radius: 12px;
            height: 20px;
            width: 100%;
            overflow: hidden;
            margin: 0.5rem 0 0.2rem;
        }
        .progress-bar-fill {
            background: #28a745;
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
        }
        .progress-text {
            font-size: 0.9rem;
            text-align: right;
            color: #495057;
            font-weight: 600;
        }
        .charts {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 3rem;
        }
        .chart-container {
            flex: 1 1 400px;
            min-height: 320px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>

{% endblock %}
